<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Deluxe Web</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #00d2ff; --accent: #9d50bb; --bg: #050505; --glass: rgba(255, 255, 255, 0.1); }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #050505 100%); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        .top-bar { width: 90%; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .balance-box { background: var(--glass); padding: 10px 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: #00ff88; }
        .inv-btn { background: var(--glass); border: 1px solid var(--primary); color: white; padding: 10px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }

        /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ */
        #update-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-content { background: linear-gradient(135deg, #1e2a3a, #000); padding: 25px; border-radius: 20px; border: 1px solid var(--primary); width: 85%; text-align: center; }
        #news-text { text-align: left; font-size: 0.9rem; color: #ccc; margin: 15px 0; }

        .case-scene { position: relative; margin-top: 60px; width: 260px; height: 260px; display: flex; align-items: center; justify-content: center; }
        .case-glow { position: absolute; width: 100%; height: 100%; background: var(--primary); filter: blur(60px); opacity: 0.3; border-radius: 50%; }
        .case-img { width: 220px; z-index: 2; transition: transform 0.3s; }
        .spinning { animation: shake 0.5s infinite ease-in-out; }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }

        #inventory-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); display: none; flex-direction: column; align-items: center; z-index: 100; padding-top: 40px; }
        .inv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-height: 70vh; overflow-y: auto; padding: 10px; }
        .inv-card { background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; font-size: 0.8rem; }

        .btn { background: linear-gradient(90deg, var(--primary), var(--accent)); border: none; padding: 15px 40px; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="update-modal">
        <div class="modal-content">
            <h2 id="news-title" style="color: var(--primary);">–ó–ê–ì–†–£–ó–ö–ê...</h2>
            <div id="news-text"></div>
            <button class="btn" onclick="closeModal()">–ü–û–ù–Ø–¢–ù–û</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="balance-box">üí∞ <span id="coins">1000</span></div>
        <button class="inv-btn" onclick="toggleInventory()">üéí</button>
    </div>

    <div class="case-scene">
        <div class="case-glow" id="glow"></div>
        <img src="https://cdn-icons-png.flaticon.com/512/6161/6161301.png" id="main-img" class="case-img">
    </div>

    <h2 id="status">–ö–ï–ô–° –ì–û–¢–û–í</h2>
    <button class="btn" id="roll-btn" onclick="openCase()">–û–¢–ö–†–´–¢–¨ (50)</button>

    <div id="inventory-modal">
        <h1>üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h1>
        <div class="inv-grid" id="inv-grid"></div>
        <button class="btn" onclick="toggleInventory()" style="background: #333;">–ù–ê–ó–ê–î</button>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. –î–ê–ù–ù–´–ï
    let coins = parseInt(localStorage.getItem('coins')) || 1000;
    let myItems = JSON.parse(localStorage.getItem('myItems')) || [];
    let marketLots = JSON.parse(localStorage.getItem('marketLots')) || []; // –í –±—É–¥—É—â–µ–º —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

    const itemsConfig = {
        "Common Bot": { price: 50, img: "https://cdn-icons-png.flaticon.com/512/4712/4712139.png", color: "#00d2ff" },
        "Rare Cyber": { price: 200, img: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", color: "#9d50bb" },
        "Ultra Legend": { price: 1000, img: "https://cdn-icons-png.flaticon.com/512/4712/4712095.png", color: "#ffcc00" }
    };

    function updateUI() {
        document.getElementById('coins').innerText = coins;
        localStorage.setItem('coins', coins);
        localStorage.setItem('myItems', JSON.stringify(myItems));
        localStorage.setItem('marketLots', JSON.stringify(marketLots));
    }

    function showScreen(screenId, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('screen-' + screenId).classList.add('active');
        el.classList.add('active');
        
        if(screenId === 'inv') renderInv();
        if(screenId === 'market') renderMarket();
    }

    // --- –õ–û–ì–ò–ö–ê –ü–†–û–î–ê–ñ–ò ---

    // 1. –ü—Ä–æ–¥–∞—Ç—å –±–æ—Ç—É (75% –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞)
    function sellToBot(id) {
        const idx = myItems.findIndex(i => i.id === id);
        if(idx === -1) return;

        const basePrice = itemsConfig[myItems[idx].name].price;
        const sellPrice = Math.floor(basePrice * 0.75); // 75% —Ü–µ–Ω—ã

        if(confirm(`–ü—Ä–æ–¥–∞—Ç—å –±–æ—Ç—É –∑–∞ ${sellPrice} –º–æ–Ω–µ—Ç? (–ë—ã—Å—Ç—Ä—ã–π –≤—ã–∫—É–ø)`)) {
            coins += sellPrice;
            myItems.splice(idx, 1);
            updateUI();
            renderInv();
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    // 2. –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç
    function listOnMarket(id) {
        const idx = myItems.findIndex(i => i.id === id);
        if(idx === -1) return;

        const userPrice = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ü–µ–Ω—É –¥–ª—è –º–∞—Ä–∫–µ—Ç–∞:", itemsConfig[myItems[idx].name].price);
        if (!userPrice || isNaN(userPrice) || userPrice <= 0) {
            tg.showAlert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞!");
            return;
        }

        const item = myItems.splice(idx, 1)[0];
        const lot = {
            ...item,
            marketPrice: parseInt(userPrice),
            ownerId: tg.initDataUnsafe.user?.id || "local_user" // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
        };

        marketLots.push(lot);
        updateUI();
        renderInv();
        tg.showAlert("–õ–æ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç!");
    }

    // 3. –°–Ω—è—Ç—å —Å –º–∞—Ä–∫–µ—Ç–∞
    function removeFromMarket(id) {
        const idx = marketLots.findIndex(l => l.id === id);
        if(idx === -1) return;

        const currentUserId = tg.initDataUnsafe.user?.id || "local_user";
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        if(marketLots[idx].ownerId !== currentUserId) {
            tg.showAlert("–≠—Ç–æ –Ω–µ –≤–∞—à –ª–æ—Ç!");
            return;
        }

        const item = marketLots.splice(idx, 1)[0];
        delete item.marketPrice;
        myItems.push(item);
        
        updateUI();
        renderMarket();
        tg.showAlert("–ü—Ä–µ–¥–º–µ—Ç –≤–µ—Ä–Ω—É–ª—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å");
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê ---

    function renderInv() {
        const grid = document.getElementById('inv-grid');
        grid.innerHTML = myItems.length ? "" : "<p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>";
        myItems.forEach(item => {
            const config = itemsConfig[item.name];
            const botPrice = Math.floor(config.price * 0.75);
            const card = document.createElement('div');
            card.className = "inv-card";
            card.style.borderColor = config.color;
            card.innerHTML = `
                <img src="${config.img}" style="width:50px;"><br>
                <b>${item.name}</b><br>
                <button class="sell-btn" onclick="sellToBot(${item.id})">–ë–û–¢–£ (+${botPrice})</button>
                <button class="sell-btn" style="background:var(--primary)" onclick="listOnMarket(${item.id})">–ú–ê–†–ö–ï–¢</button>
            `;
            grid.appendChild(card);
        });
    }

    function renderMarket() {
        const grid = document.getElementById('market-system-grid');
        grid.innerHTML = marketLots.length ? "" : "<p>–ù–∞ –º–∞—Ä–∫–µ—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –ª–æ—Ç–æ–≤</p>";
        const currentUserId = tg.initDataUnsafe.user?.id || "local_user";

        marketLots.forEach(lot => {
            const config = itemsConfig[lot.name];
            const isMine = lot.ownerId === currentUserId;
            const card = document.createElement('div');
            card.className = "inv-card";
            card.style.borderColor = isMine ? "#00ff88" : config.color;
            card.innerHTML = `
                <img src="${config.img}" style="width:50px;"><br>
                <small>${isMine ? "–ú–û–ô –õ–û–¢" : "–ü–†–û–î–ê–í–ï–¶"}</small><br>
                <b>${lot.name}</b><br>
                <div style="color:#00ff88; margin:5px 0;">üí∞ ${lot.marketPrice}</div>
                ${isMine ? 
                    `<button class="sell-btn" onclick="removeFromMarket(${lot.id})">–°–ù–Ø–¢–¨</button>` : 
                    `<button class="sell-btn" style="background:#00d2ff">–ö–£–ü–ò–¢–¨</button>`
                }
            `;
            grid.appendChild(card);
        });
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (openCase, checkNews –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
</script>
</body>
</html>

