<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NFT Tycoon</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
 --bg:#050505;--glass:rgba(255,255,255,.06);
 --primary:#00d2ff;--accent:#9d50bb;--green:#00ff88;
}
body{
 margin:0;background:radial-gradient(circle,#1a1a2e,#050505);
 color:#fff;font-family:Segoe UI,sans-serif;
 display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;
}
.top{margin-top:20px;display:flex;justify-content:space-between;width:90%;z-index:10;}
.balance{background:var(--glass);padding:8px 16px;border-radius:20px;color:var(--green);font-weight:800}
.screen{display:none;flex-direction:column;align-items:center;width:100%;height:100%;padding-bottom:90px;position:absolute;top:0}
.screen.active{display:flex}
.btn{padding:14px 30px;border:none;border-radius:18px; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff;font-weight:800;cursor:pointer}
.nav{position:fixed;bottom:20px;background:rgba(0,0,0,.8); padding:12px 30px;border-radius:30px;display:flex;gap:30px;z-index:100;}
.nav div{font-size:1.5rem;opacity:.3;cursor:pointer}
.nav .active{opacity:1;color:var(--primary);transform:scale(1.2)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:90%;margin-top:80px;max-height:60vh;overflow-y:auto;}
.card{background:var(--glass);padding:15px;border-radius:20px;text-align:center;border:1px solid rgba(255,255,255,0.05)}
.card img{width:50px}
.small-btn{font-size:.65rem; padding:4px 8px; margin-top:5px; background:rgba(255,255,255,0.1); border:1px solid var(--primary); color:white; border-radius:5px;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.95); display:none;align-items:center;justify-content:center;z-index:5000}
.popup{background:#111;padding:25px;border-radius:30px;text-align:center;}
.list{width:90%;margin-top:80px;max-height:60vh;overflow-y:auto}
.item{display:flex;justify-content:space-between;align-items:center; background:var(--glass);padding:12px;border-radius:15px;margin-bottom:8px}
</style>
</head>
<body>
<div class="top">
 <div class="balance">üí∞ <span id="coins">...</span></div>
 <div style="font-weight:900;font-size:.7rem">NFT TYCOON</div>
</div>

<div id="case" class="screen active">
 <img src="https://cdn-icons-png.flaticon.com/512/6161/6161301.png" width="180" style="margin-top:100px;cursor:pointer" onclick="openCasePreview()">
 <h3 id="status">–ö–ï–ô–° –ì–û–¢–û–í</h3>
 <button class="btn" onclick="openCase()">–û–¢–ö–†–´–¢–¨ (50)</button>
</div>

<div id="inv" class="screen">
 <h2 style="margin-top:60px">üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
 <div class="grid" id="invGrid"></div>
</div>

<div id="market" class="screen">
 <h2 style="margin-top:60px">‚öñÔ∏è –ú–ê–†–ö–ï–¢</h2>
 <div class="list" id="marketList"></div>
</div>

<div id="top" class="screen">
 <h2 style="margin-top:60px">üèÜ –¢–û–ü</h2>
 <div class="list" id="topList"></div>
</div>

<div id="casePreview" class="overlay">
 <div class="popup">
   <h3>–í–ù–£–¢–†–ò –ö–ï–ô–°–ê:</h3>
   <div id="caseItems" style="margin-bottom:20px; text-align:left;"></div>
   <button class="btn" onclick="closePreview()">–ó–ê–ö–†–´–¢–¨</button>
 </div>
</div>

<div class="nav">
 <div class="active" onclick="show('case',this)">üì¶</div>
 <div onclick="show('inv',this)">üéí</div>
 <div onclick="show('market',this)">‚öñÔ∏è</div>
 <div onclick="show('top',this)">üèÜ</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–≤–æ–µ–º—É —Å–µ—Ä–≤–µ—Ä—É
const SERVER_URL = "https://bb467bab2ab377a7-92-63-106-58.serveousercontent.com"; // –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç–æ–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω
const API_URL = SERVER_URL + "/api";

// –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
const MY_ID = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "12345";
const MY_NAME = tg.initDataUnsafe?.user?.first_name || "Guest";

const itemData = {
 "Common Bot": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712139.png",price:20},
 "Rare Cyber": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712109.png",price:100},
 "Ultra Legend": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712095.png",price:500},
 "Gold Dragon": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712102.png",price:1500}
};

let coins=0, myInv=[];

async function apiRequest(data){
    return fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    }).then(r=>r.json());
}

async function loadData(){
 try {
    const r = await fetch(`${API_URL}?user_id=${MY_ID}`);
    const d = await r.json();
    coins = d.balance; 
    myInv = d.inventory;
    document.getElementById("coins").innerText = coins;
    if(document.getElementById("inv").classList.contains("active")) renderInv();
 } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", e); }
}

function openCasePreview(){
    const listEl = document.getElementById("caseItems");
    listEl.innerHTML="";
    Object.keys(itemData).forEach(i=>{
        listEl.innerHTML+=`<div>‚Ä¢ ${i} (${itemData[i].price}üí∞)</div>`;
    });
    document.getElementById("casePreview").style.display="flex";
}

function closePreview(){ document.getElementById("casePreview").style.display="none"; }

async function openCase(){
 if(coins < 50){ alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ üí∞"); return; }
 await apiRequest({action:"open_case", user_id:MY_ID});
 const keys = Object.keys(itemData);
 const win = keys[Math.floor(Math.random()*keys.length)];
 await apiRequest({action:"add_item", user_id:MY_ID, item:win});
 alert("–í–∞–º –≤—ã–ø–∞–ª–æ: " + win + "!");
 await loadData();
}

function renderInv(){
 const grid = document.getElementById("invGrid");
 grid.innerHTML = myInv.length ? "" : "<p style='grid-column:1/3; text-align:center;'>–ü–£–°–¢–û</p>";
 myInv.forEach((it, i)=>{
    grid.innerHTML+=`
    <div class="card">
        <img src="${itemData[it.name].img}">
        <div class="small">${it.name}</div>
        <button class="small-btn" onclick="sellBot(${i})">–ë–û–¢–£</button>
        <button class="small-btn" onclick="listMarket(${i})">–†–´–ù–û–ö</button>
    </div>`;
 });
}

async function sellBot(idx){
 const it = myInv[idx];
 const gain = Math.floor(itemData[it.name].price * 0.75);
 await apiRequest({action:"sell_bot", user_id:MY_ID, item_id:it.id, gain:gain});
 await loadData();
}

async function listMarket(idx){
 const p = prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏:");
 if(!p || isNaN(p)) return;
 const it = myInv[idx];
 await apiRequest({action:"list_market", user_id:MY_ID, name:MY_NAME, item_id:it.id, price:parseInt(p)});
 await loadData();
}

async function loadMarket(){
 const list = document.getElementById("marketList");
 list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
 try {
    const r = await fetch(`${API_URL}?action=market`);
    const d = await r.json();
    list.innerHTML = d.length ? "" : "<p style='text-align:center;'>–ú–ê–†–ö–ï–¢ –ü–£–°–¢</p>";
    d.forEach(l=>{
        list.innerHTML += `
        <div class="item">
            <span><b>${l.item}</b> <br><small>–ø—Ä–æ–¥–∞–≤–µ—Ü: ${l.seller_name}</small></span>
            <span>${l.price}üí∞ ${l.seller_id === MY_ID ? 
                `<button class="small-btn" onclick="cancelLot(${l.slot})">–°–ù–Ø–¢–¨</button>` : 
                `<button class="small-btn" onclick="buy(${l.slot})">–ö–£–ü–ò–¢–¨</button>`}
            </span>
        </div>`;
    });
 } catch(e) { list.innerHTML="–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Ä—ã–Ω–∫–æ–º"; }
}

async function buy(s){ await apiRequest({action:"buy", user_id:MY_ID, slot:s}); await loadData(); loadMarket(); }
async function cancelLot(s){ await apiRequest({action:"cancel_lot", user_id:MY_ID, slot:s}); await loadData(); loadMarket(); }

async function loadTop(){
 const list = document.getElementById("topList");
 list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
 try {
    const r = await fetch(`${API_URL}?action=top`);
    const d = await r.json();
    list.innerHTML = "";
    d.forEach((p, i) => {
        list.innerHTML += `<div class="item"><span>#${i+1} ${p.u}</span> <b>${p.b}üí∞</b></div>`;
    });
 } catch(e) { list.innerHTML="–û—à–∏–±–∫–∞ –¢–û–ü–∞"; }
}

function show(id, el){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.querySelectorAll(".nav div").forEach(n=>n.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 el.classList.add("active");
 if(id==="inv") loadData();
 if(id==="market") loadMarket();
 if(id==="top") loadTop();
}

// –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
loadData();
</script>
</body>
</html>
