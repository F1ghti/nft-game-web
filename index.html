<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Deluxe Roulette</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #00d2ff; --accent: #9d50bb; --bg: #050505; --glass: rgba(255, 255, 255, 0.1); }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #050505 100%); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { width: 90%; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; z-index: 10; }
        .balance-box { background: var(--glass); padding: 10px 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: #00ff88; }

        /* –≠–∫—Ä–∞–Ω –∫–µ–π—Å–∞ –∏ –†–£–õ–ï–¢–ö–ê */
        .screen { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; padding-bottom: 80px; }
        .screen.active { display: flex; }

        .case-preview { width: 180px; cursor: pointer; transition: transform 0.3s; z-index: 5; }
        .case-preview:active { transform: scale(0.9); }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä—É–ª–µ—Ç–∫–∏ */
        .roulette-container {
            position: relative;
            width: 100%;
            height: 120px;
            background: rgba(0,0,0,0.5);
            border-top: 2px solid var(--primary);
            border-bottom: 2px solid var(--primary);
            overflow: hidden;
            display: none; /* –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä—É—á–µ–Ω–∏–∏ */
            margin: 20px 0;
        }
        .roulette-line {
            display: flex;
            position: absolute;
            left: 0;
            top: 10px;
            transition: transform 4s cubic-bezier(0.15, 0, 0.05, 1); /* –ü–ª–∞–≤–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–∫ –≤ –ö–° */
        }
        .roulette-item {
            min-width: 100px;
            height: 100px;
            margin: 0 5px;
            background: var(--glass);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 4px solid #ccc;
        }
        .roulette-item img { width: 70px; }
        .roulette-marker {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ff4444;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 15px #ff4444;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–µ–π—Å–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 20px;
            width: 80%;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--primary);
        }

        /* –û—Å—Ç–∞–ª—å–Ω–æ–µ (–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ú–∞—Ä–∫–µ—Ç) */
        .inv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-height: 65vh; overflow-y: auto; padding: 10px; }
        .inv-card { background: var(--glass); padding: 15px; border-radius: 15px; text-align: center; border-bottom: 4px solid transparent; }
        .inv-card img { width: 60px; }

        .nav-menu { position: fixed; bottom: 20px; display: flex; gap: 20px; background: rgba(0,0,0,0.8); padding: 12px 25px; border-radius: 25px; border: 1px solid var(--glass); z-index: 100; }
        .nav-item { font-size: 1.5rem; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; color: var(--primary); }

        .btn { background: linear-gradient(90deg, var(--primary), var(--accent)); border: none; padding: 15px 40px; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="balance-box">üí∞ <span id="coins">...</span></div>
        <div style="font-weight: bold; letter-spacing: 2px;">NFT DELUXE</div>
    </div>

    <div id="screen-case" class="screen active">
        <img src="https://cdn-icons-png.flaticon.com/512/6161/6161301.png" class="case-preview" onclick="openPreview()">
        <p style="font-size: 0.7rem; opacity: 0.6;">–ù–∞–∂–º–∏ –Ω–∞ –∫–µ–π—Å, —á—Ç–æ–±—ã –∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å</p>
        
        <div class="roulette-container" id="roulette-box">
            <div class="roulette-marker"></div>
            <div class="roulette-line" id="roulette-line"></div>
        </div>

        <h2 id="status">–ö–ï–ô–° –ì–û–¢–û–í</h2>
        <button class="btn" id="roll-btn" onclick="startRoulette()">–û–¢–ö–†–´–¢–¨ (50)</button>
    </div>

    <div id="preview-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞:</h3>
            <div id="preview-list"></div>
            <button class="btn" style="width:100%" onclick="document.getElementById('preview-modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="screen-inv" class="screen">
        <h2 style="margin-top: 60px;">üéí –ú–û–ò –í–ï–©–ò</h2>
        <div class="inv-grid" id="inv-grid"></div>
    </div>

    <div id="screen-market" class="screen">
        <h2 style="margin-top: 60px;">üõí –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°</h2>
        <div class="inv-grid" id="market-grid"></div>
    </div>

    <div class="nav-menu">
        <div class="nav-item active" onclick="showScreen('case', this)">üì¶</div>
        <div class="nav-item" onclick="showScreen('inv', this)">üéí</div>
        <div class="nav-item" onclick="showScreen('market', this)">üõí</div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const SERVER_URL = "https://5f50d4760f71.ngrok-free.app"; // –¢–í–û–ô NGROK
    const MY_ID = tg.initDataUnsafe.user?.id ? String(tg.initDataUnsafe.user.id) : 'guest_' + Math.random().toString(36).substr(2, 9);

    let coins = 1000;
    let myItems = JSON.parse(localStorage.getItem('myItems')) || [];
    let marketLots = [];

    const itemsConfig = {
        "Common Bot": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712139.png", color: "#00d2ff" },
        "Rare Cyber": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", color: "#9d50bb" },
        "Ultra Legend": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712095.png", color: "#ffcc00" }
    };

    function updateUI() {
        document.getElementById('coins').innerText = coins;
        localStorage.setItem('myItems', JSON.stringify(myItems));
    }

    // --- –õ–û–ì–ò–ö–ê –†–£–õ–ï–¢–ö–ò ---
    function startRoulette() {
        if (coins < 50) { tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!"); return; }
        
        coins -= 50;
        updateUI();
        syncBalanceWithServer();

        const btn = document.getElementById('roll-btn');
        const line = document.getElementById('roulette-line');
        const box = document.getElementById('roulette-box');
        const status = document.getElementById('status');
        const caseImg = document.querySelector('.case-preview');

        btn.disabled = true;
        caseImg.style.display = 'none';
        box.style.display = 'block';
        status.innerText = "–ö–†–£–¢–ò–ú...";

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 50 —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –ª–µ–Ω—Ç—ã
        line.innerHTML = '';
        line.style.transition = 'none';
        line.style.transform = 'translateX(0)';

        const itemsKeys = Object.keys(itemsConfig);
        const tape = [];
        for(let i=0; i<50; i++) {
            const key = itemsKeys[Math.floor(Math.random() * itemsKeys.length)];
            tape.push(key);
            const el = document.createElement('div');
            el.className = 'roulette-item';
            el.style.borderBottomColor = itemsConfig[key].color;
            el.innerHTML = `<img src="${itemsConfig[key].img}">`;
            line.appendChild(el);
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 45-–π —ç–ª–µ–º–µ–Ω—Ç)
        const winIndex = 40 + Math.floor(Math.random() * 5); 
        const winName = tape[winIndex];

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        setTimeout(() => {
            line.style.transition = 'transform 4s cubic-bezier(0.15, 0, 0.05, 1)';
            // –°–º–µ—â–µ–Ω–∏–µ: (—à–∏—Ä–∏–Ω–∞ –∞–π—Ç–µ–º–∞ 100 + –º–∞—Ä–≥–∏–Ω 10) * –∏–Ω–¥–µ–∫—Å - –ø–æ–ª–æ–≤–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞ + —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ –∞–π—Ç–µ–º–∞
            const itemWidth = 110;
            const offset = (winIndex * itemWidth) - (window.innerWidth / 2) + (itemWidth / 2);
            line.style.transform = `translateX(-${offset}px)`;
        }, 50);

        setTimeout(() => {
            status.innerText = "–í–´ –í–´–ò–ì–†–ê–õ–ò: " + winName;
            status.style.color = itemsConfig[winName].color;
            myItems.push({ id: Date.now().toString(), name: winName });
            updateUI();
            btn.disabled = false;
            tg.HapticFeedback.notificationOccurred('success');
            
            // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–µ–π—Å
            setTimeout(() => {
                caseImg.style.display = 'block';
                box.style.display = 'none';
                status.style.color = 'white';
                status.innerText = "–ö–ï–ô–° –ì–û–¢–û–í";
            }, 3000);
        }, 4500);
    }

    // --- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–ï–ô–°–ê ---
    function openPreview() {
        const modal = document.getElementById('preview-modal');
        const list = document.getElementById('preview-list');
        list.innerHTML = '';
        
        Object.keys(itemsConfig).forEach(name => {
            const item = itemsConfig[name];
            const div = document.createElement('div');
            div.style = "display:flex; align-items:center; margin:10px 0; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;";
            div.innerHTML = `<img src="${item.img}" width="40" style="margin-right:15px"> 
                             <b style="color:${item.color}">${name}</b>`;
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }

    // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–ë–∞–ª–∞–Ω—Å, –ú–∞—Ä–∫–µ—Ç, –ò–Ω–≤) ---
    async function syncBalanceWithServer() {
        try { fetch(`${SERVER_URL}/market`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "sync_balance", user_id: MY_ID, balance: coins }) }); } catch (e) {}
    }

    async function initialLoad() {
        try {
            const resp = await fetch(`${SERVER_URL}/market?user_id=${MY_ID}`);
            const data = await resp.json();
            coins = data.balance; updateUI();
        } catch(e) { coins = 1000; updateUI(); }
    }

    function showScreen(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        el.classList.add('active');
        if(id === 'inv') renderInv();
        if(id === 'market') renderMarket();
    }

    function renderInv() {
        const grid = document.getElementById('inv-grid');
        grid.innerHTML = myItems.length ? "" : "–ü—É—Å—Ç–æ";
        myItems.forEach(i => {
            const conf = itemsConfig[i.name];
            const card = document.createElement('div');
            card.className = 'inv-card';
            card.style.borderBottomColor = conf.color;
            card.innerHTML = `<img src="${conf.img}"><br><b>${i.name}</b>
                <button class="sell-btn market-btn" style="background:#00d2ff" onclick="listOnMarket('${i.id}')">–ú–ê–†–ö–ï–¢</button>`;
            grid.appendChild(card);
        });
    }

    async function listOnMarket(id) {
        const idx = myItems.findIndex(i => i.id === id);
        const item = myItems[idx];
        const price = prompt("–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏:", 100);
        if(!price || isNaN(price)) return;
        try {
            const res = await fetch(`${SERVER_URL}/market`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "list_lot", lot: {...item, marketPrice: price, ownerId: MY_ID, sellerName: "–ò–≥—Ä–æ–∫"} }) });
            if(res.ok) { myItems.splice(idx,1); updateUI(); renderInv(); }
        } catch(e) {}
    }

    async function renderMarket() {
        const grid = document.getElementById('market-grid');
        grid.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        try {
            const resp = await fetch(`${SERVER_URL}/market?user_id=${MY_ID}`);
            const data = await resp.json();
            marketLots = data.lots;
            grid.innerHTML = marketLots.length ? "" : "–õ–æ—Ç–æ–≤ –Ω–µ—Ç";
            marketLots.forEach(l => {
                const conf = itemsConfig[l.name];
                const card = document.createElement('div');
                card.className = 'inv-card';
                const isOwner = String(l.ownerId) === String(MY_ID);
                card.style.borderBottomColor = isOwner ? "#00ff88" : conf.color;
                card.innerHTML = `<img src="${conf.img}"><br><small>${isOwner ? "–í–ê–® –õ–û–¢" : l.sellerName}</small><br><b>${l.name}</b><br>üí∞ ${l.marketPrice}<br>
                    ${isOwner ? `<button class="sell-btn" onclick="removeFromMarket('${l.id}')">–°–ù–Ø–¢–¨</button>` : `<button class="sell-btn market-btn" style="background:#00d2ff" onclick="buyLot('${l.id}')">–ö–£–ü–ò–¢–¨</button>`}`;
                grid.appendChild(card);
            });
        } catch(e) {}
    }

    async function buyLot(id) {
        try {
            const res = await fetch(`${SERVER_URL}/market`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "buy_lot", id: id, user_id: MY_ID }) });
            const data = await res.json();
            if(res.ok) { coins = data.new_balance; myItems.push({id: Date.now(), name: data.item_name}); updateUI(); renderMarket(); }
        } catch(e) {}
    }

    async function removeFromMarket(id) {
        try {
            const res = await fetch(`${SERVER_URL}/market`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "remove_lot", id: id, user_id: MY_ID }) });
            if(res.ok) renderMarket();
        } catch(e) {}
    }

    initialLoad();
</script>
</body>
</html>
