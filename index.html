<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const SERVER_URL = "https://df40ce8635b4c51b-92-63-106-58.serveousercontent.com"; 
    const MY_ID = tg.initDataUnsafe.user?.id ? String(tg.initDataUnsafe.user.id) : 'guest_test';
    const MY_NAME = tg.initDataUnsafe.user?.first_name || '–ò–≥—Ä–æ–∫';

    let coins = 0;
    let myItems = [];
    let pendingItem = null;
    let isSpinning = false;

    const itemsConfig = {
        "Common Bot": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712139.png", color: "#b0c3d9", price: 20 },
        "Rare Cyber": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", color: "#4b69ff", price: 100 },
        "Ultra Legend": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712095.png", color: "#eb4b4b", price: 500 },
        "Gold Dragon": { img: "https://cdn-icons-png.flaticon.com/512/4712/4712102.png", color: "#ffd700", price: 1500 }
    };

    async function loadData() {
        try {
            const r = await fetch(`${SERVER_URL}/market?user_id=${MY_ID}`);
            const d = await r.json();
            coins = d.balance;
            myItems = d.inventory;
            document.getElementById('coins').innerText = coins;
            document.getElementById('status').innerText = "–ì–û–¢–û–í";
            document.getElementById('roll-btn').disabled = false;
        } catch(e) { document.getElementById('status').innerText = "–û–®–ò–ë–ö–ê"; }
    }

    async function loadTop() {
        const list = document.getElementById('top-list');
        list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        try {
            const r = await fetch(`${SERVER_URL}/market?action=top`);
            const data = await r.json();
            list.innerHTML = "";
            data.forEach((player, index) => {
                let medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `#${index + 1}`;
                list.innerHTML += `
                    <div class="list-item" style="${player.username === MY_NAME ? 'border: 1px solid var(--primary); background: rgba(0,210,255,0.1);' : ''}">
                        <div class="item-info">
                            <span style="font-weight:bold; width:25px;">${medal}</span>
                            <div class="item-name">${player.username}</div>
                        </div>
                        <div class="item-price">${player.balance} üí∞</div>
                    </div>`;
            });
        } catch(e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–û–ü–∞"; }
    }

    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: startRoulette, collectItem, renderInv, sellBot, listMarket, buyMarket) ...

    function showScreen(id, el) {
        if(isSpinning) return;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        el.classList.add('active');
        
        if(id === 'inv') renderInv();
        if(id === 'market') loadMarket();
        if(id === 'top') loadTop(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¢–û–ü –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
    }

    loadData();
</script>
