<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Tycoon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root{ --bg:#050505; --glass:rgba(255,255,255,.06); --primary:#00d2ff; --accent:#9d50bb; --green:#00ff88; }
        body{ margin:0; background:radial-gradient(circle,#1a1a2e,#050505); color:#fff; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; height:100vh; overflow:hidden; }
        .top{ margin-top:20px; display:flex; justify-content:space-between; width:90%; z-index:10; }
        .balance{ background:var(--glass); padding:8px 16px; border-radius:20px; color:var(--green); font-weight:800; border:1px solid rgba(0,255,136,0.2); }
        .screen{ display:none; flex-direction:column; align-items:center; width:100%; height:100%; padding-bottom:90px; position:absolute; top:0; }
        .screen.active{ display:flex; }
        .btn{ padding:14px 30px; border:none; border-radius:18px; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; font-weight:800; cursor:pointer; }
        .nav{ position:fixed; bottom:20px; background:rgba(0,0,0,.8); padding:12px 25px; border-radius:30px; display:flex; gap:25px; z-index:100; border:1px solid rgba(255,255,255,0.1); }
        .nav div{ font-size:1.4rem; opacity:.3; cursor:pointer; }
        .nav .active{ opacity:1; color:var(--primary); transform:scale(1.2); }
        .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; width:90%; margin-top:80px; max-height:60vh; overflow-y:auto; }
        .card{ background:var(--glass); padding:15px; border-radius:20px; text-align:center; border:1px solid rgba(255,255,255,0.05); }
        .card img{ width:50px; }
        .small-btn{ font-size:.65rem; padding:4px 8px; margin-top:5px; background:rgba(255,255,255,0.1); border:1px solid var(--primary); color:white; border-radius:5px; }
        .list{ width:90%; margin-top:80px; max-height:60vh; overflow-y:auto; }
        .item{ display:flex; justify-content:space-between; align-items:center; background:var(--glass); padding:12px; border-radius:15px; margin-bottom:8px; }

        /* –†–£–õ–ï–¢–ö–ê */
        .roulette-container { position: relative; width: 100%; height: 140px; background: rgba(255,255,255,0.03); border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); margin-top: 100px; overflow: hidden; display: none; }
        .roulette-track { display: flex; position: absolute; left: 0; top: 0; height: 100%; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); }
        .roulette-item { width: 120px; height: 100%; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .roulette-item img { width: 60px; height: 60px; }
        .pointer { position: absolute; left: 50%; top: 0; width: 4px; height: 100%; background: var(--green); z-index: 10; box-shadow: 0 0 15px var(--green); transform: translateX(-50%); }
        #debug-log { font-size: 10px; color: #555; position: fixed; top: 0; width: 100%; text-align: center; }
    </style>
</head>
<body>

<div id="debug-log">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</div>

<div class="top">
    <div class="balance">üí∞ <span id="coins">...</span></div>
    <div style="font-weight:900; font-size:.7rem; color:var(--primary)">NFT TYCOON</div>
</div>

<div id="case" class="screen active">
    <div id="roulette" class="roulette-container">
        <div class="pointer"></div>
        <div id="track" class="roulette-track"></div>
    </div>
    <img id="caseStaticImg" src="https://cdn-icons-png.flaticon.com/512/6161/6161301.png" width="180" style="margin-top:100px;cursor:pointer">
    <h3 id="status">–ö–ï–ô–° –ì–û–¢–û–í</h3>
    <button id="openBtn" class="btn" onclick="openCase()">–û–¢–ö–†–´–¢–¨ (50)</button>
</div>

<div id="inv" class="screen">
    <h2 style="margin-top:60px">üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
    <div class="grid" id="invGrid"></div>
</div>

<div id="market" class="screen">
    <h2 style="margin-top:60px">‚öñÔ∏è –ú–ê–†–ö–ï–¢</h2>
    <div class="list" id="marketList"></div>
</div>

<div id="top-screen" class="screen">
    <h2 style="margin-top:60px">üèÜ –¢–û–ü</h2>
    <div class="list" id="topList"></div>
</div>

<div class="nav">
    <div class="active" onclick="show('case',this)">üì¶</div>
    <div onclick="show('inv',this)">üéí</div>
    <div onclick="show('market',this)">‚öñÔ∏è</div>
    <div onclick="show('top-screen',this)">üèÜ</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const SERVER_URL = "https://41ce26c1ca617b9a-92-63-106-58.serveousercontent.com";
    const API_URL = SERVER_URL + "/api";

    const itemData = {
        "Common Bot": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712139.png",price:20},
        "Rare Cyber": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712109.png",price:100},
        "Ultra Legend": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712095.png",price:500},
        "Gold Dragon": {img:"https://cdn-icons-png.flaticon.com/512/4712/4712102.png",price:1500}
    };

    let MY_ID = null;
    let coins = 0, myInv = [], isSpinning = false;

    function init() {
        MY_ID = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : null;
        const log = document.getElementById("debug-log");

        if (!MY_ID) {
            log.innerText = "–û–®–ò–ë–ö–ê: –ó–∞–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –ò–ì–†–ê–¢–¨ –≤ –±–æ—Ç–µ!";
            log.style.color = "red";
            return;
        }

        log.innerText = "ID: " + MY_ID + " | –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
        loadData();
    }

    async function loadData() {
        try {
            const r = await fetch(`${API_URL}?user_id=${MY_ID}`);
            const d = await r.json();

            if (d.error === "not_registered") {
                document.body.innerHTML = "<h2 style='text-align:center;margin-top:100px'>üì± –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ –±–æ—Ç–µ!</h2>";
                return;
            }

            coins = d.balance;
            myInv = d.inventory || [];
            document.getElementById("coins").innerText = coins;
            renderInv();
        } catch(e) { console.error(e); }
    }

    function renderInv() {
        const grid = document.getElementById("invGrid");
        grid.innerHTML = myInv.length ? "" : "<p style='grid-column:1/3'>–ü–£–°–¢–û</p>";
        myInv.forEach((it, i) => {
            grid.innerHTML += `<div class="card"><img src="${itemData[it.name].img}"><div style="font-size:10px">${it.name}</div><button class="small-btn" onclick="sellBot(${it.id},'${it.name}')">–ü–†–û–î–ê–¢–¨</button></div>`;
        });
    }

    async function sellBot(id, name) {
        const gain = Math.floor(itemData[name].price * 0.7);
        await fetch(API_URL, { method:"POST", body: JSON.stringify({action:"sell_bot", user_id:MY_ID, item_id:id, gain:gain})});
        loadData();
    }

    async function openCase() {
        if (isSpinning || coins < 50) return;
        isSpinning = true;
        
        const res = await fetch(API_URL, { method:"POST", body: JSON.stringify({action:"open_case", user_id:MY_ID}) }).then(r=>r.json());
        if(res.error) { isSpinning = false; return; }

        const keys = Object.keys(itemData);
        const win = keys[Math.floor(Math.random()*keys.length)];
        
        const track = document.getElementById("track");
        const staticImg = document.getElementById("caseStaticImg");
        const roulette = document.getElementById("roulette");

        staticImg.style.display = "none";
        roulette.style.display = "block";
        track.style.transition = "none";
        track.style.transform = "translateX(0)";
        track.innerHTML = "";

        for (let i = 0; i < 60; i++) {
            const name = (i === 55) ? win : keys[Math.floor(Math.random()*keys.length)];
            track.innerHTML += `<div class="roulette-item"><img src="${itemData[name].img}"></div>`;
        }

        setTimeout(() => {
            const targetPos = (55 * 120) + 60 - (roulette.offsetWidth / 2);
            track.style.transition = "transform 5s cubic-bezier(0.15, 0, 0.15, 1)";
            track.style.transform = `translateX(-${targetPos}px)`;
        }, 50);

        setTimeout(async () => {
            await fetch(API_URL, { method:"POST", body: JSON.stringify({action:"add_item", user_id:MY_ID, item:win}) });
            alert("–í—ã–ø–∞–ª–æ: " + win);
            isSpinning = false;
            staticImg.style.display = "block";
            roulette.style.display = "none";
            loadData();
        }, 5500);
    }

    async function loadTop() {
        const r = await fetch(`${API_URL}?action=top`).then(r=>r.json());
        document.getElementById("topList").innerHTML = r.map((p,i)=>`<div class="item"><span>#${i+1} ${p.u}</span><b>${p.b}üí∞</b></div>`).join('');
    }

    function show(id, el) {
        document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
        document.querySelectorAll(".nav div").forEach(n=>n.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        el.classList.add("active");
        if(id === 'top-screen') loadTop();
    }

    setTimeout(init, 500);
</script>
</body>
</html>
