<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NFT Tycoon</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
 --bg:#050505;
 --glass:rgba(255,255,255,.06);
 --primary:#00d2ff;
 --accent:#9d50bb;
 --green:#00ff88;
}
body{
 margin:0;
 background:radial-gradient(circle,#1a1a2e,#050505);
 color:#fff;
 font-family:Segoe UI,sans-serif;
 display:flex;
 flex-direction:column;
 align-items:center;
 height:100vh;
 overflow:hidden;
}
.top{margin-top:20px;display:flex;justify-content:space-between;width:90%}
.balance{background:var(--glass);padding:8px 16px;border-radius:20px;color:var(--green);font-weight:800}
.screen{display:none;flex-direction:column;align-items:center;width:100%;height:100%;padding-bottom:90px;position:absolute;top:0}
.screen.active{display:flex}
.btn{padding:14px 30px;border:none;border-radius:18px; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff;font-weight:800;cursor:pointer}
.nav{position:fixed;bottom:20px;background:rgba(0,0,0,.8); padding:12px 30px;border-radius:30px;display:flex;gap:30px}
.nav div{font-size:1.5rem;opacity:.3;cursor:pointer}
.nav .active{opacity:1;color:var(--primary);transform:scale(1.2)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:90%}
.card{background:var(--glass);padding:15px;border-radius:20px;text-align:center}
.card img{width:50px}
.small{font-size:.65rem}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.95); display:none;align-items:center;justify-content:center;z-index:5000}
.popup{background:#111;padding:25px;border-radius:30px;animation:pop .4s}
@keyframes pop{from{transform:scale(.7)}to{transform:scale(1)}}
.list{width:90%;max-height:60vh;overflow-y:auto}
.item{display:flex;justify-content:space-between; background:var(--glass);padding:12px;border-radius:15px;margin-bottom:8px}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∫–µ–π—Å–∞ */
#case img{transition: transform 0.5s;}
#case.open img{transform: translateY(-100px) rotate(-10deg);}
#nftDrop{opacity:0;transition: opacity 0.8s, transform 0.8s;transform: scale(0.5);}
#nftDrop.show{opacity:1;transform: scale(1);}
</style>
</head>
<body>
<div class="top">
 <div class="balance">üí∞ <span id="coins">0</span></div>
 <div style="font-weight:900;font-size:.7rem">NFT TYCOON</div>
</div>

<!-- CASE -->
<div id="case" class="screen active">
 <img src="https://cdn-icons-png.flaticon.com/512/6161/6161301.png" width="180" style="margin-top:100px;cursor:pointer">
 <button class="btn" style="margin-top:20px" onclick="openCase()">–û–¢–ö–†–´–¢–¨ –ö–ï–ô–° (50)</button>
 <div id="nftDrop"></div>
</div>

<!-- INVENTORY -->
<div id="inv" class="screen">
 <h2 style="margin-top:60px">üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
 <div class="grid" id="invGrid"></div>
</div>

<!-- MARKET -->
<div id="market" class="screen">
 <h2 style="margin-top:60px">‚öñÔ∏è –ú–ê–†–ö–ï–¢</h2>
 <div class="list" id="marketList"></div>
</div>

<!-- TOP -->
<div id="top" class="screen">
 <h2 style="margin-top:60px">üèÜ –¢–û–ü</h2>
 <div class="list" id="topList"></div>
</div>

<!-- CASE CONTENT -->
<div id="casePreview" class="overlay">
 <div class="popup">
   <h3>–°–û–î–ï–†–ñ–ò–ú–û–ï –ö–ï–ô–°–ê</h3>
   <div id="caseItems"></div>
   <button class="btn" onclick="closePreview()">–ó–ê–ö–†–´–¢–¨</button>
 </div>
</div>

<div class="nav">
 <div class="active" onclick="show('case',this)">üì¶</div>
 <div onclick="show('inv',this)">üéí</div>
 <div onclick="show('market',this)">‚öñÔ∏è</div>
 <div onclick="show('top',this)">üèÜ</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const SERVER="https://bb467bab2ab377a7-92-63-106-58.serveousercontent.com";
let MY_ID=null;
let MY_NAME="";

if(tg.initDataUnsafe && tg.initDataUnsafe.user){
    MY_ID=String(tg.initDataUnsafe.user.id);
    MY_NAME=tg.initDataUnsafe.user.first_name;
} else {
    document.body.innerHTML="<h2>–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram Web App</h2>";
    throw "NOT TG";
}

const items={
 "Common Bot":{img:"https://cdn-icons-png.flaticon.com/512/4712/4712139.png",price:20},
 "Rare Cyber":{img:"https://cdn-icons-png.flaticon.com/512/4712/4712109.png",price:100},
 "Ultra Legend":{img:"https://cdn-icons-png.flaticon.com/512/4712/4712095.png",price:500},
 "Gold Dragon":{img:"https://cdn-icons-png.flaticon.com/512/4712/4712102.png",price:1500}
};

let coins=0,myInv=[];

async function api(data){
    return fetch(SERVER,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    }).then(r=>r.json());
}

async function load(){
    try{
        const r=await fetch(`${SERVER}?user_id=${MY_ID}`);
        const d=await r.json();
        coins=d.balance||0;
        myInv=d.inventory||[];
        document.getElementById("coins").innerText=coins;
        renderInv();
        loadMarket();
        loadTop();
    }catch(e){console.log(e);}
}

function openCasePreview(){
    const caseItems=document.getElementById("caseItems");
    caseItems.innerHTML="";
    Object.keys(items).forEach(i=>{
        caseItems.innerHTML+=`<div>${i} ‚Äî ${items[i].price}üí∞</div>`;
    });
    document.getElementById("casePreview").style.display="flex";
}

function closePreview(){document.getElementById("casePreview").style.display="none";}

// –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
async function openCase(){
    if(coins<50) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç");

    const caseDiv=document.getElementById("case");
    const nftDiv=document.getElementById("nftDrop");

    // —É–º–µ–Ω—å—à–µ–Ω–∏–µ –º–æ–Ω–µ—Ç
    coins-=50;
    document.getElementById("coins").innerText=coins;

    // –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
    caseDiv.classList.add("open");
    nftDiv.className=""; // —Å–±—Ä–æ—Å –∞–Ω–∏–º–∞—Ü–∏–∏
    nftDiv.innerHTML="";

    const keys=Object.keys(items);
    const win=keys[Math.floor(Math.random()*keys.length)];
    const img=document.createElement("img");
    img.src=items[win].img;
    img.style.width="100px";
    nftDiv.appendChild(img);

    // –∂–¥—ë–º 0.6 —Å–µ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    await new Promise(r=>setTimeout(r,600));

    nftDiv.classList.add("show"); // –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ NFT
    await api({action:"add_item",user_id:MY_ID,item:win});

    await load(); // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    alert("–í—ã–ø–∞–ª–æ: "+win);

    // —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫–µ–π—Å–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫
    setTimeout(()=>caseDiv.classList.remove("open"),1000);
}

function renderInv(){
    const invGrid=document.getElementById("invGrid");
    invGrid.innerHTML=myInv.length?"":"<p>–ü–£–°–¢–û</p>";
    myInv.forEach((it,i)=>{
        invGrid.innerHTML+=`
        <div class="card">
            <img src="${items[it.name].img}">
            <div class="small">${it.name}</div>
            <button class="small" onclick="sellBot(${i})">–ë–û–¢–£</button>
            <button class="small" onclick="listMarket(${i})">–ú–ê–†–ö–ï–¢</button>
        </div>`;
    });
}

async function sellBot(i){
    const it=myInv[i];
    await api({action:"sell_bot",user_id:MY_ID,item_id:it.id, gain:Math.floor(items[it.name].price*0.75)});
    await load();
}

async function listMarket(i){
    const p=prompt("–¶–µ–Ω–∞");
    if(!p) return;
    const it=myInv[i];
    await api({action:"list_market",user_id:MY_ID,name:MY_NAME,item:it.name,item_id:it.id,price:+p});
    await load();
}

async function loadMarket(){
    const r=await fetch(`${SERVER}?action=market`);
    const d=await r.json();
    const marketList=document.getElementById("marketList");
    marketList.innerHTML="";
    d.forEach(l=>{
        marketList.innerHTML+=`<div class="item">
            <span>${l.item} (${l.price}üí∞)</span>
            ${l.sid===MY_ID ? `<button onclick="cancelLot(${l.slot})">–°–ù–Ø–¢–¨</button>` : `<button onclick="buy(${l.slot})">–ö–£–ü–ò–¢–¨</button>`}
        </div>`;
    });
}

async function buy(s){ 
    await api({action:"buy",user_id:MY_ID,slot:s}); 
    await load();
}

async function cancelLot(s){ 
    await api({action:"cancel_lot",user_id:MY_ID,slot:s}); 
    await loadMarket(); 
}

async function loadTop(){
    const r=await fetch(`${SERVER}?action=top`);
    const d=await r.json();
    const topList=document.getElementById("topList");
    topList.innerHTML="";
    d.forEach((p,i)=>topList.innerHTML+=`<div class="item">#${i+1} ${p.u} ‚Äî ${p.b}üí∞</div>`);
}

function show(id,el){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".nav div").forEach(n=>n.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    el.classList.add("active");
    if(id==="inv") renderInv();
    if(id==="market") loadMarket();
    if(id==="top") loadTop();
}

load();
</script>
</body>
</html>
